(function(p,r){typeof exports=="object"&&typeof module<"u"?module.exports=r():typeof define=="function"&&define.amd?define(r):(p=typeof globalThis<"u"?globalThis:p||self,p.Draper=r())})(this,function(){"use strict";const p="";function r({url:e,async:t=!1,defer:n=!1,callback:o=()=>{}}){if(document.querySelector(`script[src="${e}"]`))s(`Script for resource: ${e} already exists.`);else{const i=document.createElement("script");i.type="text/javascript",i.src=e,i.async=t,i.defer=n,document.head.append(i)}o()}function d(e=()=>{}){window.googletag=window.googletag||{cmd:[]},window.googletag.cmd.push(e)}const h=window.innerWidth<700;function I(e=window.location.search){const t=new URLSearchParams(e);return Object.fromEntries(t.entries())}const s=(...e)=>{const t=I(),{debugads:n=!1}=t;if(n){const o=new Date;console.log("[Draper]",...e,o.toLocaleTimeString(),`${o.getMilliseconds()}ms`)}},j=e=>Array.isArray(e)&&e.every(t=>Array.isArray(t)&&t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number"),B=(e,t)=>Array.isArray(e)&&Array.isArray(t)&&e.length<=t.length&&e.every(n=>Array.isArray(n)&&j(n));var O=(e=>(e.IMPRESSION_VIEWABLE="impressionViewable",e.SLOT_LOADED="slotOnload",e.SLOT_RENDERED="slotRenderEnded",e.SLOT_REQUESTED="slotRequested",e.SLOT_RESPONSE_RECEIVED="slotResponseReceived",e.SLOT_VISIBILITY_CHANGED="slotVisibilityChanged",e))(O||{}),w=(e=>(e.AD_BLOCKER="blocked_campaigns",e.NOUN_KEYWORDS="Keyword",e.NOUN_CATEGORIES="category",e.LYTICS_SEGMENTS="LyticsSegments",e.REFRESH="refresh",e))(w||{}),S=(e=>(e.Desktop="tim.mdp.com",e.Mobile="tim.mdp.mob",e.FacebookInstantArticle="tim.mdp.fbia.com",e))(S||{});const c=Object.freeze({Large:[969,499],Medium:[727,179],Small:[0,0]}),C="https://securepubads.g.doubleclick.net/tag/js/gpt.js";let D=[];function $(e=12,t=5,n=1){window.googletag.pubads().enableLazyLoad({fetchMarginPercent:e,renderMarginPercent:t,mobileScaling:n})}function P(e,t={}){for(const[n,o]of Object.entries(t))e.setTargeting(n,o)}function k(e,t){const n=window.googletag.sizeMapping();e.sort((o,i)=>i[0]-o[0]);for(const[o,i]of[...t].entries())typeof e[o]<"u"&&n.addSize(e[o],i);return n.build()}function z({id:e,adUnitPath:t,sizes:n,viewPortBreakPoints:o=D,slotLevelTargeting:i={},display:a="all",companionAd:l}){if(!e)throw new Error("The 'id' is required.");if(!t)throw new Error(`The 'adUnitPath' for ad slot ${e} is required.`);if(a==="mobile"&&!h||a==="desktop"&&h){s(`The ad slot ${e} will only be defined on ${a}.`);return}const g=B(n,o),m=g?[...n].flat(1):[...n],u=window.googletag.defineSlot(t,m,e);if(u){if(P(u,{...i,...g?{breakpoints:o.map(([f,L])=>`${f}x${L}`).join("|")}:{},responsive:String(g),sizes:[...new Set(m.map(([f,L])=>`${f}x${L}`))].join("|")}),g){const f=k(o,n);u.defineSizeMapping(f)}l&&(u.addService(googletag.companionAds()),googletag.pubads().enableVideoAds()),u.addService(window.googletag.pubads())}}function U(e=[]){e.length>0&&d(()=>{s("Refreshing ads:",e.map(t=>t.getSlotElementId()).join(",")),window.googletag.pubads().refresh(e)})}function q(){d(()=>{window.googletag.pubads().refresh()})}function y(){var e;return(e=window.googletag.pubads().getSlots())!=null?e:[]}function F(e){d(()=>{for(const t of e)z(t);W(y()),le(y())})}function M({id:e,adUnitPath:t="",slotLevelTargeting:n={},addElement:o=!1}){d(()=>{if(o){const a=document.createElement("div");a.setAttribute("id",e),a.setAttribute("style","display:none;width:0px;height:0px"),document.body.append(a)}const i=window.googletag.defineOutOfPageSlot(t,e);i&&(P(i,n),i.addService(window.googletag.pubads()))})}function R(e,t){const n=()=>{window.googletag.pubads().addEventListener(e,t)};window.googletag.pubadsReady?n():d(()=>{n()})}function E(e={}){d(()=>{for(const[t,n]of Object.entries(e))window.googletag.pubads().setTargeting(t,n)})}function Q(){d(()=>{const e=y().filter(t=>!t.getOutOfPage());E({adslots:`${e.length}`})})}function Y(){return window.googletag.pubadsReady?window.googletag.pubads().isInitialLoadDisabled():!1}function x(e=5e3){const t=new Set;R(O.SLOT_VISIBILITY_CHANGED,o=>{const{slot:i,inViewPercentage:a}=o;a<50?t.delete(i):a>=50&&t.add(i)}),setInterval(()=>{if(document.hasFocus()&&document.visibilityState!=="hidden"){const o=[...t];U(o)}},e)}function K(){const e=googletag.pubads().getTargetingKeys(),t=e.map(n=>googletag.pubads().getTargeting(n));return Object.fromEntries(e.map((n,o)=>[n,t[o].join(",")]))}function G({lazyLoad:e,enableSingleRequestMode:t,adRefreshInterval:n,disableInitialLoad:o,viewPortBreakPoints:i}={},a={},l=!1){window.googletag=window.googletag||{cmd:[]},l&&r({url:C,async:!0,callback:()=>{s("Appended googletag script to the head tag of the page.")}}),d(()=>{E(a),o&&(window.googletag.pubads().disableInitialLoad(),s("`disableInitialLoad` was called, which means you will need to call the `refresh` method to load the ads.")),e&&$(),t&&window.googletag.pubads().enableSingleRequest(),window.googletag.enableServices()}),typeof i<"u"&&(D=i),x(n)}const H="https://pub.doubleverify.com/signals/pub.js#ctx=21226187&cmp=DV759520",v=["ids","bsc","vlp","tvp"];function W(e=[]){d(()=>{window.PQ.cmd.push(()=>{window.PQ.loadSignalsForSlots(e)})})}function Z(){d(()=>{Y()?window.PQ.cmd.push(()=>{window.PQ.loadSignals(v)}):s("DoubleVerify: Initial load must be disabled to ensure DV is able to pass the signals to you for targeting.")})}function J(e,t){window.PQ.cmd.push(()=>{window.PQ.getTargeting({signals:v,adUnits:e},(n,o)=>{n?t(n):t(!1,o)})})}function X({dynamicallyInsertScript:e=!1}={}){window.PQ=window.PQ||{cmd:[]},e&&r({url:H,async:!0}),Z()}const ee="https://c.amazon-adsystem.com/aax2/apstag.js";function te(e=[]){const t=[];for(const n of e){const[o]=n.getSizes(),{width:i,height:a}=o;t.push({slotID:n.getSlotElementId(),slotName:n.getSlotId().getAdUnitPath(),sizes:[[i,a]]})}return t}function ne(e=[],t=()=>{}){const n=te(e);return new Promise((o,i)=>{n.length>0&&(s("No Amazon(APS) slots to fetch bids for."),i()),window.apstag.fetchBids({slots:n},()=>{window.apstag.setDisplayBids(),t(),o()})})}function oe(e,t=!1){window.apstag=window.apstag||{init(){window.apstag._Q.push(["i",arguments,Date.now()])},fetchBids(){window.apstag._Q.push(["f",arguments,Date.now()])},setDisplayBids(){},_Q:[]},t&&r({url:ee,async:!0,callback:()=>{s("Dynamically appended the APS script to the head tag of the page. However, it's highly recommended to load the APS library statically.")}}),window.apstag.init(e,()=>{s("APS initialized")})}const ie=(e="")=>`https://micro.rubiconproject.com/prebid/dynamic/${e}.js`;function V(e){window.pbjs.que.push(e)}function ae(e,t=()=>{}){return new Promise(n=>{V(()=>{window.pbjs.rp.requestBids({callback(){t(),n()},gptSlotObjects:e})})})}function se({magniteId:e},t=!1){window.pbjs=window.pbjs||{},window.pbjs.que=window.pbjs.que||[],t&&r({url:ie(e),async:!0,callback:()=>{s("Dynamically appended the Prebid script to the head tag of the page. However, it's highly recommended to load the Prebid library statically.")}}),V(()=>{s("Prebid initialized")})}const de=[[728,90],[970,250],[320,50],[320,480],[300,250],[300,50],[300,600],[100,1]];function re(e=[]){const t=[];for(const n of e){const[o]=n.getSizes();typeof o<"u"&&o!=="fluid"&&de.some(([i,a])=>i===o.width&&a===o.height)&&t.push(n)}return t}function le(e){window.draperBiddingReady||s("Bidding services are not ready.");const t=re(e),n=2e3,o={adServerRequestSent:!1,aps:!1,prebid:!1};function i(){o.adServerRequestSent||(o.adServerRequestSent=!0,q())}function a(){o.aps&&o.prebid&&i()}Promise.allSettled([ne(t,()=>{o.aps=!0,a()}),ae(t,()=>{o.prebid=!0,a()})]).then(()=>s("Fetched all bids!")).catch(l=>{s(l)}),window.setTimeout(i,n)}function ce(e){const{enabled:t,amazon:n={enabled:!1,config:{}},prebid:o={enabled:!1,config:{}}}=e;if(!t){s("Header bidding disabled for all bidding services.");return}window.draperBiddingReady=!1,n.enabled&&oe(n.config),o.enabled&&se(o.config),window.draperBiddingReady=!0}const A="https://ai.time.com";async function ge(e){try{const t=await fetch(`${A}/noun/extract/${e}`),{keywords:n}=await t.json();return n.join(",")}catch(t){throw new Error(t)}}async function ue(e){try{const t=await fetch(`${A}/noun/topics/get_topics/${e}`),{data:n}=await t.json();return n.b2b_content.join(",")}catch(t){throw new Error(t)}}async function fe(e=""){try{const t=await fetch(`${A}/adblocker/match/${e}`),{block_status:n}=await t.json();return n.filter(o=>o.to_block).map(o=>o.ab_campaign_id).join(",")}catch(t){throw new Error(t)}}function pe({contentType:e="",contentId:t=""}){["article","gallery","collection-article","single-column-article","longform","video-article"].includes(e)&&t&&Promise.all([fe(t),ge(t),ue(t)]).then(([o="",i="",a=""])=>E({[w.AD_BLOCKER]:o,[w.NOUN_KEYWORDS]:i,[w.NOUN_CATEGORIES]:a})).catch(o=>{s(o)})}const _={gamNetworkCode:"21801468956",dynamicallyInsertScripts:!1,googlePublisherTags:{adRefreshInterval:3e4,lazyLoad:!0,enableSingleRequestMode:!0,disableInitialLoad:!0,sizeMap:[[c.Large,[[970,250]]],[c.Medium,[[160,600],[728,90]]],[c.Small,[[1,1],[300,50],[300,250],[300,600],[320,50],[336,280]]]],viewPortBreakPoints:[c.Large,c.Medium,c.Small]},bidding:{enabled:!0,amazon:{enabled:!0,deals:!0,config:{pubID:"3928",adServer:"googletag",videoAdServer:"DFP",simplerGPT:!0,bidTimeout:2e3,cmpTimeout:2e3,deals:!0}},prebid:{enabled:!0,config:{magniteId:"20996"}}}};let N,b;function T(){const{section:e="",contentType:t=""}=b;return`/${N}/${h?S.Mobile:S.Desktop}/${e}/${t}`}return{init(e={}){const{gamNetworkCode:t=_.gamNetworkCode,pageLevelTargeting:n={},googlePublisherTags:o=_.googlePublisherTags,bidding:i=_.bidding}=e,a=I(),{testads:l}=a;N=t,b={...n,...l&&{test:l}},ce(i),G(o,b),X();const{cid:g,contentType:m}=b;pe({contentId:g,contentType:m})},defineAd({id:e,sizes:t,adUnitPath:n=T(),slotLevelTargeting:o={}}){this.defineAds([{adUnitPath:n,id:e,sizes:t,slotLevelTargeting:o}])},defineAds(e){const t=e.map(n=>{var o;return{...n,adUnitPath:(o=n.adUnitPath)!=null?o:T()}});F(t),Q()},defineOutOfPageAd({id:e,adUnitPath:t=T(),slotLevelTargeting:n={},addElement:o=!0}){M({id:e,slotLevelTargeting:n,addElement:o,adUnitPath:t})},getPageLevelAdTargetingKeyVals(){return K()},getQualityTargeting(e,t){J(e,t)},addEventListener:(e,t)=>{R(e,t)}}});
